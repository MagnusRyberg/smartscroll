name: Azure Static Web Apps - Simple SPA deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy SPA (repo root)
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Package site artifact
        run: |
          echo "Creating site artifact tarball..."
          # Prefer creating the archive from git HEAD to avoid files changing during read
          if [ -d ".git" ]; then
            echo "Creating archive from git HEAD"
            git archive --format=tar.gz -o site.tar.gz HEAD
          else
            echo "No .git directory found, falling back to tar (may fail if files change while reading)"
            tar --exclude='./.git' --exclude='./node_modules' -czf site.tar.gz -C . .
          fi
          ls -la site.tar.gz

      - name: Upload site artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-artifact
          path: site.tar.gz

      - name: Create SPA config (staticwebapp.config.json)
        run: |
          cat > staticwebapp.config.json <<'JSON'
          {
            "navigationFallback": {
              "rewrite": "/index.html",
              "exclude": ["/images/*", "/css/*", "/js/*"]
            }
          }
          JSON
          echo "Created staticwebapp.config.json:" && cat staticwebapp.config.json

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: "."
          api_location: ""
          output_location: "."
          # Explicitly tell Oryx there is no build step for this simple static site
          app_build_command: "echo \"No build step for static SPA\""
          skip_deploy_on_missing_secrets: true
